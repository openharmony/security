{
    "month": "2024-08",
    "vulnerabilities": [
        {
            "month": "2024-08",
            "vul_id": {
                "cve": "CVE-2024-36904",
                "openharmony-sa": ""
            },
            "severity": "high",
            "vul_description": {
                "zh": "Anderson Nascimento 报告了在 tcp_twsk_unique() 函数中存在的一个“用后释放”漏洞，并给出了很好的分析。自提交 ec94c2696f0b（“tcp/dccp: 避免 timewait 哈希表操作中的一次原子操作”）以来，inet_twsk_hashdance() 函数在将 TIME-WAIT 套接字放入 ehash 哈希表并释放桶锁之后，会设置该套接字的 sk_refcnt 引用计数。因此，存在一个短暂的时间窗口，在此期间，其他线程可能会在 connect() 过程中尝试重用该端口，并对引用计数为零的 TIME-WAIT 套接字在 tcp_twsk_unique() 中调用 sock_hold()。",
                "en": "Anderson Nascimento reported a use-after-free splat in tcp_twsk_unique() with nice analysis.Since commit ec94c2696f0b (\"tcp/dccp: avoid one atomic operation for timewait hashdance\"), inet_twsk_hashdance() sets TIME-WAIT socket's sk_refcnt after putting it into ehash and releasing the bucket lock.Thus, there is a small race window where other threads could try to reuse the port during connect() and call sock_hold() in tcp_twsk_unique() for the TIME-WAIT socket with zero refcnt."
            },
            "vul_impact": {
                "zh": "如果发生这种情况，tcp_twsk_unique() 所获取的 refcnt（引用计数）将被覆盖，而 sock_put() 调用将导致下溢，从而在其他地方触发真正的“用后释放”错误。为了避免“用后释放”问题，我们需要在 tcp_twsk_unique() 中使用 refcount_inc_not_zero() 函数，如果它返回 false，则放弃重用该端口。",
                "en": "If that happens, the refcnt taken by tcp_twsk_unique() is overwritten and sock_put() will cause underflow, triggering a real use-after-free somewhere else.To avoid the use-after-free, we need to use refcount_inc_not_zero() in tcp_twsk_unique() and give up on reusing the port if it returns false."
            },
            "disclosure": {
                "zh": "https://gitee.com/openharmony/security/blob/master/zh/security-disclosure/2024/2024-08.md",
                "en": "https://gitee.com/openharmony/security/blob/master/en/security-disclosure/2024/2024-08.md"
            },
            "patch_info": {
                "4.0.x": {
                    "patch_url": [
                        "https://gitee.com/openharmony/kernel_linux_5.10/commit/af869d736e60bb16dd947ab84a5b03b4b641b9b9"
                    ],
                    "patch_file": [
                        "https://gitee.com/openharmony/kernel_linux_5.10/commit/af869d736e60bb16dd947ab84a5b03b4b641b9b9.patch"
                    ],
                    "diff_file": [
                        "https://gitee.com/openharmony/kernel_linux_5.10/commit/af869d736e60bb16dd947ab84a5b03b4b641b9b9.diff"
                    ]
                },
                "4.1.x": {
                    "patch_url": [
                        "https://gitee.com/openharmony/kernel_linux_5.10/commit/aa052d359c5cbaf4ff3b19e77c9aca3dcfb15c2d"
                    ],
                    "patch_file": [
                        "https://gitee.com/openharmony/kernel_linux_5.10/commit/aa052d359c5cbaf4ff3b19e77c9aca3dcfb15c2d.patch"
                    ],
                    "diff_file": [
                        "https://gitee.com/openharmony/kernel_linux_5.10/commit/aa052d359c5cbaf4ff3b19e77c9aca3dcfb15c2d.diff"
                    ]
                }
            },
            "affected_projects": "kernel_linux_5.10",
            "object_type": "kernel_linux",
            "affected_versions": [
                "4.0.0-4.0.2",
                "4.1.0-4.1.2"
            ],
            "affected_device": {
                "mini": {
                    "liteos": {
                        "rics-v": {
                            "scan_strategy": {
                                "ssts": {
                                    "enable": false
                                },
                                "ists": {
                                    "enable": false
                                }
                            }
                        }
                    }
                },
                "small": {
                    "liteos": {
                        "rics-v": {
                            "scan_strategy": {
                                "ssts": {
                                    "enable": false
                                },
                                "ists": {
                                    "enable": false
                                }
                            }
                        }
                    },
                    "linux": {
                        "arm": {
                            "scan_strategy": {
                                "ssts": {
                                    "enable": false
                                },
                                "ists": {
                                    "enable": false
                                }
                            }
                        }
                    }
                },
                "standard": {
                    "linux": {
                        "arm": {
                            "scan_strategy": {
                                "ssts": {
                                    "enable": false
                                },
                                "ists": {
                                    "enable": true,
                                    "yara": {
                                        "affected_files": [
                                            "/dev/block/platform/fe310000.sdhci/by-name/boot_linux"
                                        ],
                                        "yara_rules": [
                                            "CVE-2024-36904.yara"
                                        ]
                                    }
                                }
                            }
                        },
                        "arm64": {
                            "scan_strategy": {
                                "ssts": {
                                    "enable": false
                                },
                                "ists": {
                                    "enable": false
                                }
                            }
                        }
                    }
                }
            }
        }
    ]
}