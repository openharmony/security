/*
* Copyright (c) 2024 Beijing University of Posts and Telecommunications.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
* http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
import "console" 

rule CVE_2024_58058
{
    meta:
        date = "2025-07-01" 
        openharmony_sa = "" 
        cve = "CVE-2024-58058" 
        description = "Detects fix for CVE-2024-58058: ubifs skip dumping tnc tree when zroot is null"
        author = "pwnnofans"
        severity = "medium"
        score = "5.7"
        affected_versions = "OpenHarmony-v5.0.3-Release"
        reference = "https://gitee.com/openharmony/kernel_linux_5.10/commit/5f67e45a933f110fd5295e4d277fc50f56c27633"
        affected_files = "/boot/extlinux/Image" // 受影响的文件路径

    strings:
        // 主要特征字符串：修复后添加的空指针检查提示信息
        // 如果检测到此字符串，说明修复已生效
        // 如果检测不到，说明修复未生效（可能被编译器优化或未编译进内核）
        $str1 = "empty TNC tree in memory" ascii wide
        
        // 补充调试字符串：用于辅助确认文件正确性
        // 如果 $str2, $str3, $func1 都存在，说明这是正确的内核文件（包含ubifs_dump_tnc函数）
        // 但这些字符串的存在不能作为pass testcase的条件，只有 $str1 存在才能pass
        $str2 = "(pid %d) start dumping TNC tree" ascii wide
        $str3 = "(pid %d) finish dumping TNC tree" ascii wide
        $func1 = "ubifs_dump_tnc" ascii wide
        
    condition:
        // 主要检测：特征字符串存在，说明修复已生效
        // 补充检测：如果主要字符串不存在，但函数名和相关调试字符串存在，说明函数存在但修复可能未完全生效
        ($str1) and ($func1 and ($str2 or $str3)) and console.log("CVE-2024-58058 testcase pass")
}

