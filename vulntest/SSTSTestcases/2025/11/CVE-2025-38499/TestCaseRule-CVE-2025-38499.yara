/* * Copyright (c) 2025 Beijing University of Posts and Telecommunications.
 * * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at  
 * * http://www.apache.org/licenses/LICENSE-2.0  
 * * Unless required by applicable law or agreed to in writing, software  
 * distributed under the License is distributed on an "AS IS" BASIS,  
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and  
 * limitations under the License.
 */ 

import "console"

rule OpenHarmony_clone_private_mount_Patch_Check_CVE_2025_21648 {
    meta:
        description = "Checks for the presence of the security patch for the clone_private_mount missing permission check vulnerability. This rule PASSES if the fix (a call to ns_capable_common) is present."
        author = "Gemini (adapted for OpenHarmony contributor)"
        date = "2025-12-17"
        cve = "CVE-2025-21648"
        product = "OpenHarmony Kernel"
        arch = "ARM64"
        test_logic = "This rule is silent on vulnerable systems and prints 'testcase pass' on patched systems."

    strings:
        $patch_full_sequence = {

            00 25 40 F9     // LDR X0, [X8, #0x48]
            A1 02 80 52     // MOV W1, #0x15
            E2 03 1F 2A     // MOV W2, WZR
            ?? ?? ?? 97     // BL <ns_capable_common> (BL的偏移依然易变，保留通配符)
            80 02 00 36
        }

    condition:
        uint32(0) == 0x464C457F and $patch_full_sequence and console.log("CVE-2025-21648 testcase pass")
}